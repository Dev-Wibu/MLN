<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý AI Tiếng Việt - Chatbot Thông Minh</title>
    <meta name="description" content="Trợ lý AI tiếng Việt với khả năng nhận diện giọng nói và phản hồi tự động. Trò chuyện bằng văn bản hoặc giọng nói một cách tự nhiên.">
    <meta name="keywords" content="AI, chatbot, tiếng Việt, trợ lý ảo, nhận diện giọng nói, text to speech">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chat-bg': '#0A0E1A',
                        'chat-surface': '#1A1F2E',
                        'chat-surface-secondary': '#252A3A',
                        'user-bubble': '#8B5CF6',
                        'bot-bubble': '#252A3A',
                        'primary-glow': '#A78BFA',
                        'mic-active': '#EF4444',
                        'voice-pulse': '#EF4444',
                        'selected-purple': '#8A2BE2'
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-mic': 'pulseMic 1.5s infinite',
                        'typing': 'typing 1.4s infinite'
                    },
                    keyframes: {
                        slideIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        pulseMic: {
                            'from': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' },
                            'to': { boxShadow: '0 0 0 20px rgba(239, 68, 68, 0)' }
                        },
                        typing: {
                            '0%': { transform: 'translateY(0px)' },
                            '28%': { transform: 'translateY(-5px)' },
                            '44%': { transform: 'translateY(0px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1A1F2E;
        }
        ::-webkit-scrollbar-thumb {
            background: #8B5CF6;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #A78BFA;
        }

        /* Gradient backgrounds - Full dark coverage */
        .gradient-primary {
            background: linear-gradient(135deg, #8B5CF6, #A78BFA);
        }
        .gradient-hero {
            background: linear-gradient(135deg, #0A0E1A, #1A1F2E);
        }
        .gradient-surface {
            background: linear-gradient(135deg, #1A1F2E, #252A3A);
        }

        /* Backdrop blur fallback */
        .backdrop-blur-lg {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* Chat background pattern - Dark */
        .chat-pattern {
            background-image:
                    radial-gradient(circle at 25% 25%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(167, 139, 250, 0.1) 0%, transparent 50%);
        }

        /* Ensure full dark no white */
        body, html {
            background-color: #0A0E1A !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        input {
            background-color: #1A1F2E !important;
            color: #F3F4F6 !important;
        }
        .bg-bot-bubble, .bg-user-bubble {
            color: #F3F4F6 !important;
        }
        #messagesContainer {
            background-color: #0A0E1A !important;
        }

        /* Custom Dropdown Styles - Separate popup, full text, compact */
        .dropdown {
            position: relative;
            width: 160px; /* Trigger width */
        }
        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: #1A1F2E;
            border: 1px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #E0E0E0;
            font-size: 0.75rem;
        }
        .dropdown-trigger:hover {
            border-color: #6B7280;
        }
        .dropdown-trigger.selected {
            background-color: #8A2BE2;
            color: white;
            border-color: #8A2BE2;
        }
        .dropdown-trigger.selected .icon-svg, .dropdown-trigger.selected .chevron-svg {
            color: white;
            fill: white;
        }
        .dropdown-menu {
            position: absolute;
            bottom: calc(100% + 0.25rem);
            left: 0;
            width: 200px; /* Wider popup for full text */
            background-color: #1A1F2E;
            border: 1px solid #374151;
            border-radius: 8px;
            box-shadow: 0 -10px 15px -3px rgba(0, 0, 0, 0.5);
            list-style: none;
            padding: 0.5rem 0; /* Tight outer padding */
            max-height: none;
            z-index: 10;
            display: none;
        }
        .dropdown.open .dropdown-menu {
            display: block;
        }
        .dropdown-item {
            display: flex;
            align-items: flex-start; /* Align top for column text */
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #E0E0E0;
            border-radius: 6px;
        }
        .dropdown-item:hover {
            background-color: #2A2C3E;
        }
        .dropdown-item.selected {
            background-color: #8A2BE2;
            color: white;
        }
        .dropdown-item.selected .icon-svg {
            fill: white;
        }
        .dropdown-item-text {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column; /* Name above desc */
            gap: 0.125rem; /* Minimal vertical gap */
        }
        .dropdown-item-name {
            font-weight: 600;
            font-size: 0.75rem;
            white-space: normal; /* Allow wrap */
            overflow: visible; /* No ellipsis */
            line-height: 1.1;
        }
        .dropdown-item-desc {
            font-size: 0.625rem;
            color: #9CA3AF;
            white-space: normal; /* Allow wrap */
            overflow: visible; /* No ellipsis */
            line-height: 1.1;
        }
        .icon-svg, .chevron-svg {
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
            fill: currentColor;
            margin-top: 0.125rem; /* Align with text top */
        }
        .chevron-svg {
            margin-left: auto;
            transition: transform 0.2s;
        }
        .dropdown.open .chevron-svg {
            transform: rotate(180deg);
        }

        /* Clear History Button */
        .clear-history-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #1A1F2E;
            border: 1px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #E0E0E0;
            font-size: 0.75rem;
        }
        .clear-history-btn:hover {
            background-color: #EF4444;
            border-color: #EF4444;
            color: white;
        }
        .clear-history-btn svg {
            width: 1rem;
            height: 1rem;
            fill: currentColor;
        }

        /* Markdown styling for chat messages */
        .markdown-content {
            line-height: 1.5;
        }
        .markdown-content p {
            margin: 0.5rem 0;
        }
        .markdown-content strong {
            font-weight: 700;
        }
        .markdown-content em {
            font-style: italic;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .markdown-content li {
            margin: 0.25rem 0;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            margin: 0.75rem 0 0.5rem;
        }
        .markdown-content h1 {
            font-size: 1.25rem;
        }
        .markdown-content h2 {
            font-size: 1.125rem;
        }
        .markdown-content h3 {
            font-size: 1rem;
        }
    </style>
</head>

<body class="font-sans m-0 p-0 h-screen overflow-hidden gradient-hero chat-pattern bg-chat-bg">
<!-- Chat Container - Full screen -->
<div class="flex flex-col h-screen w-full bg-chat-bg">
    <!-- Header -->
    <div class="bg-chat-surface/90 backdrop-blur-lg border-b border-gray-700 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 gradient-primary rounded-full flex items-center justify-center shadow-lg">
                <span class="text-sm font-bold text-white">AI</span>
            </div>
            <div>
                <h1 class="text-lg font-semibold text-white">
                    Trợ lý AI Tiếng Việt
                </h1>
                <p class="text-sm text-gray-300">
                    Sẵn sàng trò chuyện • Hỗ trợ giọng nói
                </p>
            </div>
        </div>
        <!-- Clear History Button -->
        <button id="clearHistoryButton" class="clear-history-btn">
            <svg viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            <span>Xóa lịch sử</span>
        </button>
    </div>

    <!-- Messages Area -->
    <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-chat-bg">
        <!-- Initial AI message -->
        <div class="flex justify-start animate-slide-in">
            <div class="max-w-[85%] md:max-w-[70%] px-4 py-3 rounded-2xl rounded-bl-md shadow-lg bg-bot-bubble text-gray-100 transition-all duration-300 hover:scale-[1.02]">
                <div class="markdown-content text-sm leading-relaxed">Xin chào! Tôi là trợ lý AI tiếng Việt của bạn. Bạn có thể nhắn tin hoặc nói chuyện với tôi bằng giọng nói. Tôi có thể giúp gì cho bạn?</div>
                <div class="mt-1 text-xs opacity-70" id="initialTime"></div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="border-t border-gray-700 bg-chat-surface/80 backdrop-blur-lg p-4">
        <!-- Listening Status -->
        <div id="listeningStatus" class="hidden mb-3 flex items-center justify-center">
            <div class="flex items-center space-x-2 px-4 py-2 bg-mic-active/10 border border-mic-active/30 rounded-full animate-pulse-mic">
                <div class="w-3 h-3 bg-mic-active rounded-full animate-pulse"></div>
                <span class="text-sm text-mic-active font-medium">Đang nghe...</span>
            </div>
        </div>

        <!-- Input Row -->
        <div class="flex items-center space-x-3">
            <!-- Custom Character Dropdown -->
            <div class="dropdown" id="characterDropdown">
                <div class="dropdown-trigger" id="dropdownTrigger">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <!-- Gear SVG for default -->
                        <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2-3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                    </svg>
                    <span id="selectedName">Mặc định</span>
                    <svg class="chevron-svg" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </div>
                <ul class="dropdown-menu" id="dropdownMenu">
                    <!-- Items sẽ được generate bằng JS -->
                </ul>
            </div>

            <div class="flex-1 relative">
                <input
                        type="text"
                        id="messageInput"
                        placeholder="Nhập tin nhắn hoặc sử dụng mic..."
                        class="w-full bg-chat-surface border border-gray-600/50 text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-purple-500/50 rounded-xl px-4 py-3 shadow-lg backdrop-blur-sm transition-all duration-300"
                />
            </div>

            <!-- Mic Button -->
            <button
                    id="micButton"
                    class="p-3 rounded-xl border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500"
            >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                </svg>
            </button>

            <!-- Send Button -->
            <button
                    id="sendButton"
                    class="p-3 rounded-xl gradient-primary text-white transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-purple-500/30 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50 disabled:hover:scale-100"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Typing Indicator Template (hidden) -->
<div id="typingTemplate" class="hidden flex justify-start animate-slide-in">
    <div class="bg-bot-bubble text-gray-100 px-4 py-3 rounded-2xl rounded-bl-md shadow-lg">
        <div class="flex space-x-2">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing" style="animation-delay: 0.2s;"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-typing" style="animation-delay: 0.4s;"></div>
        </div>
    </div>
</div>

<script>
    // Character data with icons and descriptions
    const characters = [
        { value: 'default', name: 'Mặc định', desc: 'Trợ lý AI tiêu chuẩn', icon: '<path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2-3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>' },
        { value: 'Socrates', name: 'Socrates', desc: 'The questioning mind', icon: '<circle cx="12" cy="8" r="4"/><path d="M12 12v8"/>' },
        { value: 'Plato', name: 'Plato', desc: 'Idealist and theoretician', icon: '<path d="M4 20h16V4H4zM8 8h8v8H8z"/>' },
        { value: 'Aristotle', name: 'Aristotle', desc: 'Empirical observer', icon: '<circle cx="12" cy="12" r="8"/><path d="M8 12l2 2 4-4"/>' },
        { value: 'Kant', name: 'Immanuel Kant', desc: 'Categorical imperative', icon: '<circle cx="12" cy="12" r="8"/><path d="M12 4v8M8 12h8"/>' },
        { value: 'Marx', name: 'Karl Marx', desc: 'Critique of capitalism', icon: '<path d="M12 2l3 6h-6l3-6zM10 20l-3-6h6l-3 6z"/>' }
    ];

    // Global variables
    let recognition = null;
    let isListening = false;
    let lastVoiceTime = 0;
    let silenceTimer = null;
    let isTyping = false;
    let currentCharacter = characters[0]; // Default selected
    let conversationId = generateUUID(); // Generate conversationId on page load

    const SILENCE_TIMEOUT = 5000; // 5 seconds
    const API_URL = 'http://localhost:8080/chat';
    const CLEAR_HISTORY_URL = 'http://localhost:8080/chat/history';

    // DOM elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const micButton = document.getElementById('micButton');
    const sendButton = document.getElementById('sendButton');
    const listeningStatus = document.getElementById('listeningStatus');
    const typingTemplate = document.getElementById('typingTemplate');
    const dropdown = document.getElementById('characterDropdown');
    const dropdownTrigger = document.getElementById('dropdownTrigger');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const selectedName = document.getElementById('selectedName');
    const clearHistoryButton = document.getElementById('clearHistoryButton');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial timestamp
        document.getElementById('initialTime').textContent = new Date().toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit"
        });

        // Generate dropdown items
        generateDropdownItems();

        // Set initial trigger
        updateTrigger();

        // Event listeners
        dropdownTrigger.addEventListener('click', toggleDropdown);
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) closeDropdown();
        });
        messageInput.addEventListener('keypress', handleKeyPress);
        sendButton.addEventListener('click', sendMessage);
        micButton.addEventListener('click', toggleListening);
        clearHistoryButton.addEventListener('click', clearChatHistory);

        // Initialize speech recognition
        initializeSpeechRecognition();
    });

    // Generate UUID for conversationId
    function generateUUID() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }

    function generateDropdownItems() {
        characters.forEach(char => {
            const li = document.createElement('li');
            li.className = 'dropdown-item';
            li.innerHTML = `
                <svg class="icon-svg" viewBox="0 0 24 24">${char.icon}</svg>
                <div class="dropdown-item-text">
                    <div class="dropdown-item-name">${char.name}</div>
                    <div class="dropdown-item-desc">${char.desc}</div>
                </div>
            `;
            li.addEventListener('click', () => selectCharacter(char));
            dropdownMenu.appendChild(li);
        });
    }

    function updateTrigger() {
        const iconSvg = document.querySelector('.dropdown-trigger .icon-svg');
        iconSvg.innerHTML = currentCharacter.icon;
        selectedName.textContent = currentCharacter.name;
        dropdownTrigger.classList.toggle('selected', currentCharacter.value !== 'default');
    }

    function selectCharacter(char) {
        currentCharacter = char;
        updateTrigger();
        closeDropdown();
        // Mark selected in menu
        dropdownMenu.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('selected'));
        event.target.closest('.dropdown-item').classList.add('selected');
    }

    function toggleDropdown() {
        dropdown.classList.toggle('open');
    }

    function closeDropdown() {
        dropdown.classList.remove('open');
    }

    // Clear Chat History
    async function clearChatHistory() {
        try {
            const response = await fetch(`${CLEAR_HISTORY_URL}?conversationId=${encodeURIComponent(conversationId)}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to clear chat history');
            const result = await response.text();
            // Clear messages from UI
            messagesContainer.innerHTML = `
                <div class="flex justify-start animate-slide-in">
                    <div class="max-w-[85%] md:max-w-[70%] px-4 py-3 rounded-2xl rounded-bl-md shadow-lg bg-bot-bubble text-gray-100 transition-all duration-300 hover:scale-[1.02]">
                        <div class="markdown-content text-sm leading-relaxed">Lịch sử trò chuyện đã được xóa. Hôm nay tôi có thể giúp gì cho bạn?</div>
                        <div class="mt-1 text-xs opacity-70">${new Date().toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" })}</div>
                    </div>
                </div>
            `;
            // Generate new conversationId
            conversationId = generateUUID();
            alert(result);
        } catch (error) {
            console.error('Clear history failed:', error);
            alert('Lỗi khi xóa lịch sử trò chuyện: ' + error.message);
        }
    }

    // Speech Recognition Setup
    function initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = "vi-VN";
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function() {
                isListening = true;
                listeningStatus.classList.remove('hidden');
                micButton.classList.add('animate-pulse-mic', 'bg-mic-active', 'border-mic-active', 'text-white');
                micButton.classList.remove('bg-gray-700', 'border-gray-600');
                lastVoiceTime = Date.now();

                silenceTimer = setInterval(() => {
                    if (Date.now() - lastVoiceTime > SILENCE_TIMEOUT) {
                        stopListening();
                        if (messageInput.value.trim()) {
                            sendMessage();
                        }
                    }
                }, 1000);
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                messageInput.value = finalTranscript + interimTranscript;
                lastVoiceTime = Date.now();
            };

            recognition.onend = function() {
                stopListening();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopListening();
            };
        } else {
            micButton.style.display = 'none';
        }
    }

    function startListening() {
        if (recognition && !isListening) {
            messageInput.value = '';
            recognition.start();
        }
    }

    function stopListening() {
        isListening = false;
        listeningStatus.classList.add('hidden');
        micButton.classList.remove('animate-pulse-mic', 'bg-mic-active', 'border-mic-active', 'text-white');
        micButton.classList.add('bg-gray-700', 'border-gray-600');

        if (silenceTimer) {
            clearInterval(silenceTimer);
            silenceTimer = null;
        }

        if (recognition) {
            recognition.stop();
        }
    }

    function toggleListening() {
        if (isListening) {
            stopListening();
            setTimeout(() => {
                if (messageInput.value.trim()) {
                    sendMessage();
                }
            }, 100);
        } else {
            startListening();
        }
    }

    // Text-to-Speech
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "vi-VN";
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            utterance.onend = function() {
                if (isListening) {
                    recognition.start();
                }
            };

            utterance.onerror = function(event) {
                console.error("Speech synthesis error:", event);
            };

            if (isListening) {
                recognition.stop();
            }

            window.speechSynthesis.speak(utterance);
        }
    }

    // Message handling
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || isTyping) return;

        addMessage(message, true);
        messageInput.value = '';

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }

        showTypingIndicator();

        try {
            const queryParams = `message=${encodeURIComponent(message)}&character=${encodeURIComponent(currentCharacter.value)}&conversationId=${encodeURIComponent(conversationId)}`;
            const response = await fetch(`${API_URL}?${queryParams}`);
            if (!response.ok) throw new Error('API error');
            const aiResponse = await response.text();

            hideTypingIndicator();
            addMessage(aiResponse, false);
            speak(aiResponse);
        } catch (error) {
            console.error('API call failed:', error);
            hideTypingIndicator();
            const fallback = 'Xin lỗi, tôi gặp lỗi khi xử lý. Hãy thử lại nhé!';
            addMessage(fallback, false);
            speak(fallback);
        }
    }

    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-slide-in`;

        const timestamp = new Date().toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit"
        });

        // Parse markdown for bot messages, use plain text for user messages
        const content = isUser ? text : marked.parse(text);

        messageDiv.innerHTML = `
            <div class="max-w-[85%] md:max-w-[70%] px-4 py-3 rounded-2xl shadow-lg transition-all duration-300 hover:scale-[1.02] ${
            isUser
                ? 'bg-user-bubble text-white rounded-br-md'
                : 'bg-bot-bubble text-gray-100 rounded-bl-md'
        }">
                <div class="markdown-content text-sm leading-relaxed">${content}</div>
                <div class="mt-1 text-xs opacity-70">${timestamp}</div>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function showTypingIndicator() {
        isTyping = true;
        const typingDiv = typingTemplate.cloneNode(true);
        typingDiv.id = 'typingIndicator';
        typingDiv.classList.remove('hidden');
        messagesContainer.appendChild(typingDiv);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        isTyping = false;
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>
</body>
</html>